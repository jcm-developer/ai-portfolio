<main class="container">
    <!-- Suggestions List -->
    <ul class="suggestions">
        <li class="suggestions-item" data-suggestion="0">
            <p class="text" data-i18n="suggestions.0">
                What projects have Jaume worked on?
            </p>
            <span class="material-symbols-outlined"> cases </span>
        </li>
        <li class="suggestions-item" data-suggestion="1">
            <p class="text" data-i18n="suggestions.1">
                Could you please provide me with Jaume's CV link?
            </p>
            <span class="material-symbols-outlined"> article_person </span>
        </li>
        <li class="suggestions-item" data-suggestion="2">
            <p class="text" data-i18n="suggestions.2">
                What are Jaume's studies and experience?
            </p>
            <span class="material-symbols-outlined"> book_ribbon </span>
        </li>
        <li class="suggestions-item" data-suggestion="3">
            <p class="text" data-i18n="suggestions.3">
                What are Jaume's skills and knowledge?
            </p>
            <span class="material-symbols-outlined">
                network_intelligence
            </span>
        </li>
    </ul>

    <!-- Chats -->
    <div class="chats-container"></div>

    <!-- Prompt -->
    <div class="prompt-container">
        <div class="prompt-wrapper">
            <form action="#" class="prompt-form">
                <input
                    type="text"
                    placeholder="Ask my assistant about me..."
                    class="prompt-input"
                    data-i18n-placeholder="placeholder"
                    required
                />
                <div class="prompt-actions">
                    <button
                        type="button"
                        id="stop-response-btn"
                        class="material-symbols-outlined">stop_circle</button
                    >
                    <button
                        id="send-prompt-btn"
                        class="material-symbols-outlined">arrow_upward</button
                    >
                </div>
            </form>
            <button id="delete-chats-btn" class="material-symbols-outlined"
                >delete</button
            >
        </div>
    </div>
</main>

<script>
    // @ts-nocheck
    import {
        applyTranslations,
        initLanguageSwitcher,
        getPreferredLanguage,
    } from "../scripts/i18n.js";

    let container, chatsContainer, promptForm, promptInput;
    let typingInterval, controller;
    let isGenerating = false;
    const chatHistory = [];
    const userData = { message: "", file: {} };

    // Helper: create message elements dynamically
    const createMsgElement = (content, ...classes) => {
        const div = document.createElement("div");
        div.classList.add("message", ...classes);
        div.innerHTML = content;
        return div;
    };

    // Helper: smooth scroll to bottom of container
    const scrollToBottom = () => {
        container?.scrollTo({
            top: container.scrollHeight,
            behavior: "smooth",
        });
    };

    // Typing effect for bot messages
    const typingEffect = (text, textElement, botMsgDiv) => {
        textElement.textContent = "";
        const words = text.split(" ");
        let wordIndex = 0;

        typingInterval = setInterval(() => {
            if (!isGenerating) {
                clearInterval(typingInterval);
                botMsgDiv.classList.remove("loading");
                document.body.classList.remove("bot-responding");
                return;
            }

            if (wordIndex < words.length) {
                textElement.textContent +=
                    (wordIndex === 0 ? "" : " ") + words[wordIndex++];
                scrollToBottom();
            } else {
                clearInterval(typingInterval);
                botMsgDiv.classList.remove("loading");
                document.body.classList.remove("bot-responding");
                isGenerating = false;
            }
        }, 40);
    };

    // Generate bot response via API call
    const generateResponse = async (botMsgDiv) => {
        const textElement = botMsgDiv.querySelector(".message-text");
        controller = new AbortController();
        isGenerating = true;

        // Get current language and select appropriate system message
        const currentLang = getPreferredLanguage();
        const systemMessage =
            currentLang === "es"
                ? import.meta.env.PUBLIC_SYSTEM_MESSAGE_ES
                : import.meta.env.PUBLIC_SYSTEM_MESSAGE_EN;

        try {
            const postResponse = await fetch(
                "https://jcm-developer-portfolio-chatbot.hf.space/gradio_api/call/predict",
                {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        data: [
                            userData.message,
                            chatHistory,
                            systemMessage,
                            512,
                            0.7,
                            0.95,
                        ],
                    }),
                    signal: controller.signal,
                },
            );

            if (!postResponse.ok) {
                throw new Error(`HTTP error! status: ${postResponse.status}`);
            }

            const { event_id } = await postResponse.json();

            if (!isGenerating) {
                throw new Error("Response generation stopped.");
            }

            const eventSource = new EventSource(
                `https://jcm-developer-portfolio-chatbot.hf.space/gradio_api/call/predict/${event_id}`,
            );

            let fullResponse = "";

            eventSource.addEventListener("generating", (event) => {
                if (!isGenerating) {
                    eventSource.close();
                    return;
                }

                try {
                    const data = JSON.parse(event.data);
                    if (Array.isArray(data) && data.length > 0) {
                        if (typeof data[0] === "string") {
                            fullResponse = data[0];
                        } else if (
                            Array.isArray(data[0]) &&
                            data[0].length > 1
                        ) {
                            fullResponse = data[0][1];
                        }
                    }

                    textElement.textContent = fullResponse
                        .replace(/\*\*([^*]+)\*\*/g, "$1")
                        .trim();
                    scrollToBottom();
                } catch (e) {
                    console.error("Error parsing SSE data:", e);
                }
            });

            eventSource.addEventListener("complete", (event) => {
                eventSource.close();

                if (!isGenerating) {
                    return;
                }

                try {
                    const data = JSON.parse(event.data);
                    if (Array.isArray(data) && data.length > 0) {
                        if (typeof data[0] === "string") {
                            fullResponse = data[0];
                        } else if (
                            Array.isArray(data[0]) &&
                            data[0].length > 1
                        ) {
                            fullResponse = data[0][1];
                        }
                    }
                } catch (e) {
                    console.error("Error parsing complete data:", e);
                }

                const cleanResponse = fullResponse
                    .replace(/\*\*([^*]+)\*\*/g, "$1")
                    .trim();

                textElement.textContent = cleanResponse;
                botMsgDiv.classList.remove("loading");
                document.body.classList.remove("bot-responding");
                isGenerating = false;

                chatHistory.push({
                    role: "user",
                    content: userData.message,
                });
                chatHistory.push({
                    role: "assistant",
                    content: cleanResponse,
                });
            });

            eventSource.addEventListener("error", (event) => {
                eventSource.close();

                if (!isGenerating) {
                    return;
                }

                textElement.style.color = "#d62939";
                textElement.textContent = "Error connecting to the server.";
                botMsgDiv.classList.remove("loading");
                document.body.classList.remove("bot-responding");
                isGenerating = false;
            });

            controller.signal.addEventListener("abort", () => {
                eventSource.close();
            });
        } catch (error) {
            if (error.name === "AbortError") {
                textElement.style.color = "#d62939";
                textElement.textContent = "Response generation stopped.";
            } else {
                textElement.style.color = "#d62939";
                textElement.textContent = error.message || "An error occurred.";
            }
            botMsgDiv.classList.remove("loading");
            document.body.classList.remove("bot-responding");
            isGenerating = false;
        } finally {
            userData.file = {};
        }
    };

    // Handle message submission
    const handleFormSubmit = (e) => {
        e.preventDefault();
        const userMessage = promptInput.value.trim();
        if (!userMessage || document.body.classList.contains("bot-responding"))
            return;

        promptInput.value = "";
        userData.message = userMessage;
        document.body.classList.add("bot-responding", "chats-active");

        const userMsgHTML = `
        <p class="message-text"></p>
    `;
        const userMsgDiv = createMsgElement(userMsgHTML, "user-message");
        userMsgDiv.querySelector(".message-text").textContent = userMessage;
        chatsContainer.appendChild(userMsgDiv);
        scrollToBottom();

        setTimeout(() => {
            const botMsgHTML = `
          <img src="${import.meta.env.BASE_URL}img/avatar.png" alt="bot" class="avatar">
          <p class="message-text">Processing...</p>
        `;
            const botMsgDiv = createMsgElement(
                botMsgHTML,
                "bot-message",
                "loading",
            );
            chatsContainer.appendChild(botMsgDiv);
            scrollToBottom();
            generateResponse(botMsgDiv);
        }, 600);
    };

    // Initialize DOM references and events
    window.addEventListener("DOMContentLoaded", () => {
        applyTranslations();
        initLanguageSwitcher();

        container = document.querySelector(".container") || document.body;
        chatsContainer = document.querySelector(".chats-container");
        promptForm = document.querySelector(".prompt-form");
        promptInput = document.querySelector(".prompt-input");

        // Stop response
        document
            .querySelector("#stop-response-btn")
            ?.addEventListener("click", () => {
                isGenerating = false;
                userData.file = {};
                controller?.abort();
                clearInterval(typingInterval);

                const loadingBot = chatsContainer?.querySelector(
                    ".bot-message.loading",
                );
                if (loadingBot) {
                    loadingBot.classList.remove("loading");
                    const textElement =
                        loadingBot.querySelector(".message-text");
                    if (
                        textElement &&
                        textElement.textContent === "Processing..."
                    ) {
                        textElement.style.color = "#d62939";
                        textElement.textContent =
                            "Response generation stopped.";
                    }
                }
                document.body.classList.remove("bot-responding");
            });

        // Delete all chats
        document
            .querySelector("#delete-chats-btn")
            ?.addEventListener("click", () => {
                chatHistory.length = 0;
                chatsContainer.innerHTML = "";
                document.body.classList.remove(
                    "bot-responding",
                    "chats-active",
                );
            });

        // Handle suggestion clicks
        document.querySelectorAll(".suggestions-item")?.forEach((item) => {
            item.addEventListener("click", () => {
                promptInput.value = item.querySelector(".text").textContent;
                promptForm.dispatchEvent(new Event("submit"));
            });
        });

        // Show/hide controls on mobile
        document.addEventListener("click", ({ target }) => {
            const wrapper = document.querySelector(".prompt-wrapper");
            const shouldHide =
                target.classList.contains("prompt-input") ||
                (wrapper.classList.contains("hide-controls") &&
                    (target.id === "add-file-btn" ||
                        target.id === "stop-response-btn"));
            wrapper.classList.toggle("hide-controls", shouldHide);
        });

        // Submit handler
        promptForm?.addEventListener("submit", handleFormSubmit);
    });
</script>
