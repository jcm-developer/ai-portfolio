<main class="container">
    <!-- Suggestions List -->
    <ul class="suggestions animate-blurred-fade-in animate-zoom-in">
        <li class="suggestions-item" data-suggestion="0">
            <p class="text" data-i18n="suggestions.0">
                What projects have Jaume worked on?
            </p>
            <span class="material-symbols-outlined"> cases </span>
        </li>
        <li class="suggestions-item" data-suggestion="1">
            <p class="text" data-i18n="suggestions.1">
                Could you please provide me with Jaume's CV link?
            </p>
            <span class="material-symbols-outlined"> article_person </span>
        </li>
        <li class="suggestions-item" data-suggestion="2">
            <p class="text" data-i18n="suggestions.2">
                What are Jaume's studies and experience?
            </p>
            <span class="material-symbols-outlined"> book_ribbon </span>
        </li>
        <li class="suggestions-item" data-suggestion="3">
            <p class="text" data-i18n="suggestions.3">
                What are Jaume's skills and knowledge?
            </p>
            <span class="material-symbols-outlined">
                network_intelligence
            </span>
        </li>
    </ul>

    <!-- Chats -->
    <div class="chats-container"></div>

    <!-- Prompt -->
    <div class="prompt-container animate-slide-in-bottom">
        <div class="prompt-wrapper">
            <form action="#" class="prompt-form">
                <input
                    type="text"
                    placeholder="Ask my assistant about me..."
                    class="prompt-input"
                    data-i18n-placeholder="placeholder"
                    required
                />
                <div class="prompt-actions">
                    <button
                        type="button"
                        id="stop-response-btn"
                        class="material-symbols-outlined">stop_circle</button
                    >
                    <button
                        id="send-prompt-btn"
                        class="material-symbols-outlined">arrow_upward</button
                    >
                </div>
            </form>
            <button id="delete-chats-btn" class="material-symbols-outlined"
                >delete</button
            >
        </div>
    </div>
</main>

<script>
    // @ts-nocheck
    import {
        applyTranslations,
        initLanguageSwitcher,
        getPreferredLanguage,
    } from "../scripts/i18n.js";
    import { projects } from "../data/projects.js";
    import { cvLinks } from "../data/cvLinks.js";

    let container, chatsContainer, promptForm, promptInput;
    let typingInterval, controller;
    let isGenerating = false;
    let pendingSuggestionIndex = null;
    const chatHistory = [];
    const userData = { message: "", file: {} };

    // Build project cards HTML
    const buildProjectCardsHTML = () => {
        const lang = getPreferredLanguage();
        const base = import.meta.env.BASE_URL;
        const cardsHTML = projects
            .map(
                (p, i) => `
            <a href="${p.url}" target="_blank" rel="noopener noreferrer" class="project-card" data-index="${i}">
                <img src="${base}${p.image}" alt="${p.name}" class="project-card-img" />
                <div class="project-card-body">
                    <span class="project-card-name">${p.name}</span>
                    <span class="project-card-desc">${p.description[lang] || p.description.en}</span>
                </div>
            </a>`,
            )
            .join("");
        return `<div class="project-cards">${cardsHTML}</div>`;
    };

    // Build CV cards HTML
    const buildCvCardsHTML = () => {
        const lang = getPreferredLanguage();
        const base = import.meta.env.BASE_URL;
        const cardsHTML = cvLinks
            .map(
                (c, i) => `
            <a href="${c.url}" target="_blank" rel="noopener noreferrer" class="project-card" data-index="${i}">
                <img src="${base}${c.image}" alt="${c.name}" class="project-card-img" />
                <div class="project-card-body">
                    <span class="project-card-name">${c.name}</span>
                    <span class="project-card-desc">${c.description[lang] || c.description.en}</span>
                </div>
            </a>`,
            )
            .join("");
        return `<div class="project-cards">${cardsHTML}</div>`;
    };

    // Helper: create message elements dynamically
    const createMsgElement = (content, ...classes) => {
        const div = document.createElement("div");
        div.classList.add("message", ...classes);
        div.innerHTML = content;
        return div;
    };

    // Helper: smooth scroll to bottom of container
    const scrollToBottom = () => {
        container?.scrollTo({
            top: container.scrollHeight,
            behavior: "smooth",
        });
    };

    // Typing effect for bot messages
    const typingEffect = (text, textElement, botMsgDiv) => {
        textElement.textContent = "";
        const words = text.split(" ");
        let wordIndex = 0;

        typingInterval = setInterval(() => {
            if (!isGenerating) {
                clearInterval(typingInterval);
                botMsgDiv.classList.remove("loading");
                document.body.classList.remove("bot-responding");
                return;
            }

            if (wordIndex < words.length) {
                textElement.textContent +=
                    (wordIndex === 0 ? "" : " ") + words[wordIndex++];
                scrollToBottom();
            } else {
                clearInterval(typingInterval);
                botMsgDiv.classList.remove("loading");
                document.body.classList.remove("bot-responding");
                isGenerating = false;
            }
        }, 40);
    };

    // Generate bot response via OpenAI API call
    const generateResponse = async (botMsgDiv) => {
        const textElement = botMsgDiv.querySelector(".message-text");
        controller = new AbortController();
        isGenerating = true;

        // Get current language and select appropriate system message
        const currentLang = getPreferredLanguage();
        const systemMessage =
            currentLang === "es"
                ? import.meta.env.PUBLIC_SYSTEM_MESSAGE_ES
                : import.meta.env.PUBLIC_SYSTEM_MESSAGE_EN;

        // Build messages array for OpenAI
        const messages = [
            { role: "system", content: systemMessage },
            ...chatHistory,
            { role: "user", content: userData.message },
        ];

        try {
            const response = await fetch(
                "https://api.openai.com/v1/chat/completions",
                {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: `Bearer ${import.meta.env.PUBLIC_OPENAI_API_KEY}`,
                    },
                    body: JSON.stringify({
                        model:
                            import.meta.env.PUBLIC_OPENAI_MODEL ||
                            "gpt-4o-mini",
                        messages: messages,
                        max_tokens: 512,
                        temperature: 0.7,
                        top_p: 0.95,
                    }),
                    signal: controller.signal,
                },
            );

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(
                    errorData?.error?.message ||
                        `HTTP error! status: ${response.status}`,
                );
            }

            if (!isGenerating) {
                throw new Error("Response generation stopped.");
            }

            const data = await response.json();
            const textResponse = (data.choices?.[0]?.message?.content || "")
                .replace(/\*\*([^*]+)\*\*/g, "$1")
                .trim();

            if (!isGenerating) {
                throw new Error("Response generation stopped.");
            }

            typingEffect(textResponse, textElement, botMsgDiv);

            chatHistory.push({
                role: "user",
                content: userData.message,
            });
            chatHistory.push({
                role: "assistant",
                content: textResponse,
            });
        } catch (error) {
            if (error.name === "AbortError") {
                textElement.style.color = "#d62939";
                textElement.textContent = "Response generation stopped.";
            } else {
                textElement.style.color = "#d62939";
                textElement.textContent = error.message || "An error occurred.";
            }
            botMsgDiv.classList.remove("loading");
            document.body.classList.remove("bot-responding");
            isGenerating = false;
        } finally {
            userData.file = {};
        }
    };

    // Handle message submission
    const handleFormSubmit = (e) => {
        e.preventDefault();
        const userMessage = promptInput.value.trim();
        if (!userMessage || document.body.classList.contains("bot-responding"))
            return;

        promptInput.value = "";
        userData.message = userMessage;
        document.body.classList.add("bot-responding", "chats-active");

        const userMsgHTML = `
        <p class="message-text"></p>
    `;
        const userMsgDiv = createMsgElement(userMsgHTML, "user-message");
        userMsgDiv.querySelector(".message-text").textContent = userMessage;
        chatsContainer.appendChild(userMsgDiv);
        scrollToBottom();

        setTimeout(() => {
            // Inject project cards if suggestion 0 was clicked — skip API call
            if (pendingSuggestionIndex === 0) {
                const cardsDiv = document.createElement("div");
                cardsDiv.classList.add(
                    "message",
                    "bot-message",
                    "project-cards-message",
                );
                cardsDiv.innerHTML = buildProjectCardsHTML();
                chatsContainer.appendChild(cardsDiv);
                scrollToBottom();

                // Static response instead of API call
                const lang = getPreferredLanguage();
                const staticMsg =
                    lang === "es"
                        ? "Aquí tienes algunos de los proyectos más destacados en los que he trabajado. ¿Quieres saber más detalles sobre alguno?"
                        : "Here are some of the most notable projects I've worked on. Do you want to know more details about any of them?";
                const botMsgHTML = `
                    <img src="${import.meta.env.BASE_URL}img/avatar.png" alt="bot" class="avatar">
                    <p class="message-text">${staticMsg}</p>
                `;
                const botMsgDiv = createMsgElement(botMsgHTML, "bot-message");
                chatsContainer.appendChild(botMsgDiv);
                scrollToBottom();
                document.body.classList.remove("bot-responding");
                pendingSuggestionIndex = null;
                return;
            }

            // Inject CV cards if suggestion 1 was clicked — skip API call
            if (pendingSuggestionIndex === 1) {
                const cardsDiv = document.createElement("div");
                cardsDiv.classList.add(
                    "message",
                    "bot-message",
                    "project-cards-message",
                    "cv-cards-message",
                );
                cardsDiv.innerHTML = buildCvCardsHTML();
                chatsContainer.appendChild(cardsDiv);
                scrollToBottom();

                // Static response instead of API call
                const lang = getPreferredLanguage();
                const staticMsg =
                    lang === "es"
                        ? "Aquí tienes mis CV's. ¿Necesitas algo más o quieres saber algo sobre mí?"
                        : "Here are my CVs. Do you need anything else or want to know something about me?";
                const botMsgHTML = `
                    <img src="${import.meta.env.BASE_URL}img/avatar.png" alt="bot" class="avatar">
                    <p class="message-text">${staticMsg}</p>
                `;
                const botMsgDiv = createMsgElement(botMsgHTML, "bot-message");
                chatsContainer.appendChild(botMsgDiv);
                scrollToBottom();
                document.body.classList.remove("bot-responding");
                pendingSuggestionIndex = null;
                return;
            }

            const botMsgHTML = `
          <img src="${import.meta.env.BASE_URL}img/avatar.png" alt="bot" class="avatar">
          <p class="message-text">Processing...</p>
        `;
            const botMsgDiv = createMsgElement(
                botMsgHTML,
                "bot-message",
                "loading",
            );
            chatsContainer.appendChild(botMsgDiv);
            scrollToBottom();
            generateResponse(botMsgDiv);
        }, 600);
    };

    // Initialize DOM references and events
    window.addEventListener("DOMContentLoaded", () => {
        applyTranslations();
        initLanguageSwitcher();

        container = document.querySelector(".container") || document.body;
        chatsContainer = document.querySelector(".chats-container");
        promptForm = document.querySelector(".prompt-form");
        promptInput = document.querySelector(".prompt-input");

        // Stop response
        document
            .querySelector("#stop-response-btn")
            ?.addEventListener("click", () => {
                isGenerating = false;
                userData.file = {};
                controller?.abort();
                clearInterval(typingInterval);

                const loadingBot = chatsContainer?.querySelector(
                    ".bot-message.loading",
                );
                if (loadingBot) {
                    loadingBot.classList.remove("loading");
                    const textElement =
                        loadingBot.querySelector(".message-text");
                    if (
                        textElement &&
                        textElement.textContent === "Processing..."
                    ) {
                        textElement.style.color = "#d62939";
                        textElement.textContent =
                            "Response generation stopped.";
                    }
                }
                document.body.classList.remove("bot-responding");
            });

        // Delete all chats
        document
            .querySelector("#delete-chats-btn")
            ?.addEventListener("click", () => {
                chatHistory.length = 0;
                chatsContainer.innerHTML = "";
                document.body.classList.remove(
                    "bot-responding",
                    "chats-active",
                );
            });

        // Handle suggestion clicks
        document.querySelectorAll(".suggestions-item")?.forEach((item) => {
            item.addEventListener("click", () => {
                const idx = parseInt(item.getAttribute("data-suggestion"), 10);
                pendingSuggestionIndex = idx;
                promptInput.value = item.querySelector(".text").textContent;
                promptForm.dispatchEvent(new Event("submit"));
            });
        });

        // Show/hide controls on mobile
        document.addEventListener("click", ({ target }) => {
            const wrapper = document.querySelector(".prompt-wrapper");
            const shouldHide =
                target.classList.contains("prompt-input") ||
                (wrapper.classList.contains("hide-controls") &&
                    (target.id === "add-file-btn" ||
                        target.id === "stop-response-btn"));
            wrapper.classList.toggle("hide-controls", shouldHide);
        });

        // Submit handler
        promptForm?.addEventListener("submit", handleFormSubmit);
    });
</script>
