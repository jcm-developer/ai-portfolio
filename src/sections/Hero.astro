<main class="container">
    <!-- Suggestions List -->
    <ul class="suggestions">
        <li class="suggestions-item" data-suggestion="0">
            <p class="text" data-i18n="suggestions.0">
                What projects have Jaume worked on?
            </p>
            <span class="material-symbols-outlined"> cases </span>
        </li>
        <li class="suggestions-item" data-suggestion="1">
            <p class="text" data-i18n="suggestions.1">
                Could you please provide me with Jaume's CV link?
            </p>
            <span class="material-symbols-outlined"> article_person </span>
        </li>
        <li class="suggestions-item" data-suggestion="2">
            <p class="text" data-i18n="suggestions.2">
                What are Jaume's studies and experience?
            </p>
            <span class="material-symbols-outlined"> book_ribbon </span>
        </li>
        <li class="suggestions-item" data-suggestion="3">
            <p class="text" data-i18n="suggestions.3">
                What are Jaume's skills and knowledge?
            </p>
            <span class="material-symbols-outlined">
                network_intelligence
            </span>
        </li>
    </ul>

    <!-- Chats -->
    <div class="chats-container"></div>

    <!-- Prompt -->
    <div class="prompt-container">
        <div class="prompt-wrapper">
            <form action="#" class="prompt-form">
                <input
                    type="text"
                    placeholder="Ask my assistant about me..."
                    class="prompt-input"
                    data-i18n-placeholder="placeholder"
                    required
                />
                <div class="prompt-actions">
                    <button
                        type="button"
                        id="stop-response-btn"
                        class="material-symbols-outlined">stop_circle</button
                    >
                    <button
                        id="send-prompt-btn"
                        class="material-symbols-outlined">arrow_upward</button
                    >
                </div>
            </form>
            <button id="delete-chats-btn" class="material-symbols-outlined"
                >delete</button
            >
        </div>
    </div>
</main>

<script>
    // @ts-nocheck
    import { Client } from "@gradio/client";
    import {
        applyTranslations,
        initLanguageSwitcher,
    } from "../scripts/i18n.js";

    let container, chatsContainer, promptForm, promptInput;
    let typingInterval, controller;
    let isGenerating = false;
    const chatHistory = [];
    const userData = { message: "", file: {} };

    // Helper: create message elements dynamically
    const createMsgElement = (content, ...classes) => {
        const div = document.createElement("div");
        div.classList.add("message", ...classes);
        div.innerHTML = content;
        return div;
    };

    // Helper: smooth scroll to bottom of container
    const scrollToBottom = () => {
        container?.scrollTo({
            top: container.scrollHeight,
            behavior: "smooth",
        });
    };

    // Typing effect for bot messages
    const typingEffect = (text, textElement, botMsgDiv) => {
        textElement.textContent = "";
        const words = text.split(" ");
        let wordIndex = 0;

        typingInterval = setInterval(() => {
            // Check if generation was stopped
            if (!isGenerating) {
                clearInterval(typingInterval);
                botMsgDiv.classList.remove("loading");
                document.body.classList.remove("bot-responding");
                return;
            }

            if (wordIndex < words.length) {
                textElement.textContent +=
                    (wordIndex === 0 ? "" : " ") + words[wordIndex++];
                scrollToBottom();
            } else {
                clearInterval(typingInterval);
                botMsgDiv.classList.remove("loading");
                document.body.classList.remove("bot-responding");
                isGenerating = false;
            }
        }, 40);
    };

    // Generate bot response via API call
    const generateResponse = async (botMsgDiv) => {
        const textElement = botMsgDiv.querySelector(".message-text");
        controller = new AbortController();
        isGenerating = true;

        // Save user message into history
        chatHistory.push({
            role: "user",
            parts: [{ text: userData.message }],
        });

        try {
            // Connect to Gradio client (sin token para Space pÃºblico)
            const client = await Client.connect(
                "jcm-developer/portfolio-chatbot",
                {
                    hf_token: import.meta.env.PUBLIC_HF_TOKEN,
                },
            );

            // Check if generation was stopped
            if (!isGenerating) {
                throw new Error("Response generation stopped.");
            }

            // Make prediction
            const requestPayload = {
                message: userData.message,
                system_message: import.meta.env.PUBLIC_SYSTEM_MESSAGE,
                max_tokens: 512,
                temperature: 0.7,
                top_p: 0.9,
            };

            const result = await client.predict("/chat", requestPayload);

            // Check again if generation was stopped
            if (!isGenerating) {
                throw new Error("Response generation stopped.");
            }

            // Extract response text - Gradio returns data as array or object
            let textResponse = "";
            if (typeof result.data === "string") {
                textResponse = result.data;
            } else if (Array.isArray(result.data)) {
                textResponse = result.data[0] || "";
            } else if (result.data && typeof result.data === "object") {
                textResponse =
                    result.data.message ||
                    result.data.text ||
                    JSON.stringify(result.data);
            }

            textResponse = textResponse
                .replace(/\*\*([^*]+)\*\*/g, "$1")
                .trim();

            // Check one more time before typing
            if (!isGenerating) {
                throw new Error("Response generation stopped.");
            }

            typingEffect(textResponse, textElement, botMsgDiv);

            chatHistory.push({
                role: "model",
                parts: [{ text: textResponse }],
            });
        } catch (error) {
            textElement.style.color = "#d62939";
            textElement.textContent =
                error.message === "Response generation stopped."
                    ? "Response generation stopped."
                    : error.message;
            botMsgDiv.classList.remove("loading");
            document.body.classList.remove("bot-responding");
            isGenerating = false;
        } finally {
            userData.file = {};
        }
    };

    // Handle message submission
    const handleFormSubmit = (e) => {
        e.preventDefault();
        const userMessage = promptInput.value.trim();
        if (!userMessage || document.body.classList.contains("bot-responding"))
            return;

        promptInput.value = "";
        userData.message = userMessage;
        document.body.classList.add("bot-responding", "chats-active");

        const userMsgHTML = `
        <p class="message-text"></p>
        ${
            userData.file.data
                ? userData.file.isImage
                    ? `<img src="data:${userData.file.mime_type};base64,${userData.file.data}" class="img-attachment" />`
                    : `<p class="file-attachment">
                  <span class="material-symbols-outlined">description</span>
                  ${userData.file.fileName}
                 </p>`
                : ""
        }
      `;
        const userMsgDiv = createMsgElement(userMsgHTML, "user-message");
        userMsgDiv.querySelector(".message-text").textContent = userMessage;
        chatsContainer.appendChild(userMsgDiv);
        scrollToBottom();

        // Simulate loading then send request
        setTimeout(() => {
            const botMsgHTML = `
          <img src="${import.meta.env.BASE_URL}img/avatar.png" alt="bot" class="avatar">
          <p class="message-text">Processing...</p>
        `;
            const botMsgDiv = createMsgElement(
                botMsgHTML,
                "bot-message",
                "loading",
            );
            chatsContainer.appendChild(botMsgDiv);
            scrollToBottom();
            generateResponse(botMsgDiv);
        }, 600);
    };

    // Initialize DOM references and events
    window.addEventListener("DOMContentLoaded", () => {
        // Apply translations and initialize language switcher
        applyTranslations();
        initLanguageSwitcher();

        container = document.querySelector(".container") || document.body;
        chatsContainer = document.querySelector(".chats-container");
        promptForm = document.querySelector(".prompt-form");
        promptInput = document.querySelector(".prompt-input");

        // Stop response
        document
            .querySelector("#stop-response-btn")
            ?.addEventListener("click", () => {
                // Immediately stop generation
                isGenerating = false;
                userData.file = {};
                controller?.abort();
                clearInterval(typingInterval);

                // Update UI immediately
                const loadingBot = chatsContainer?.querySelector(
                    ".bot-message.loading",
                );
                if (loadingBot) {
                    loadingBot.classList.remove("loading");
                    const textElement =
                        loadingBot.querySelector(".message-text");
                    if (
                        textElement &&
                        textElement.textContent === "Processing..."
                    ) {
                        textElement.style.color = "#d62939";
                        textElement.textContent =
                            "Response generation stopped.";
                    }
                }
                document.body.classList.remove("bot-responding");
            });

        // Delete all chats
        document
            .querySelector("#delete-chats-btn")
            ?.addEventListener("click", () => {
                chatHistory.length = 0;
                chatsContainer.innerHTML = "";
                document.body.classList.remove(
                    "bot-responding",
                    "chats-active",
                );
            });

        // Handle suggestion clicks
        document.querySelectorAll(".suggestions-item")?.forEach((item) => {
            item.addEventListener("click", () => {
                promptInput.value = item.querySelector(".text").textContent;
                promptForm.dispatchEvent(new Event("submit"));
            });
        });

        // Show/hide controls on mobile
        document.addEventListener("click", ({ target }) => {
            const wrapper = document.querySelector(".prompt-wrapper");
            const shouldHide =
                target.classList.contains("prompt-input") ||
                (wrapper.classList.contains("hide-controls") &&
                    (target.id === "add-file-btn" ||
                        target.id === "stop-response-btn"));
            wrapper.classList.toggle("hide-controls", shouldHide);
        });

        // Submit handler
        promptForm?.addEventListener("submit", handleFormSubmit);
    });
</script>
